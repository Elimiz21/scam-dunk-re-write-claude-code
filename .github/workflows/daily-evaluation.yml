name: Daily Stock Evaluation

on:
  # Run daily at 6 AM UTC (1 AM EST, after market close)
  schedule:
    - cron: '0 6 * * *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      upload_only:
        description: 'Only upload existing results (skip evaluation)'
        required: false
        default: 'false'
        type: boolean

jobs:
  evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max for full evaluation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install evaluation dependencies
        run: |
          cd evaluation
          npm ci || npm install

      - name: Run FMP Evaluation
        if: ${{ github.event.inputs.upload_only != 'true' }}
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          cd evaluation
          npx ts-node scripts/run-evaluation-fmp.ts

      - name: Upload to Supabase (if evaluation was skipped)
        if: ${{ github.event.inputs.upload_only == 'true' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          cd evaluation
          npx ts-node scripts/upload-to-supabase.ts --all

      - name: Commit results to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all new evaluation results
          git add evaluation/results/*.json evaluation/results/*.md evaluation/results/**/*.md || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new evaluation results to commit"
          else
            DATE=$(date +%Y-%m-%d)
            git commit -m "Add evaluation results for ${DATE}"
            git push
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results-${{ github.run_number }}
          path: |
            evaluation/results/fmp-evaluation-*.json
            evaluation/results/fmp-summary-*.json
            evaluation/results/fmp-high-risk-*.json
          retention-days: 30

  notify-on-failure:
    needs: evaluate
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Daily Evaluation Failed - ${date}`,
              body: `The daily stock evaluation workflow failed.\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nPlease check the logs and re-run if needed.`,
              labels: ['bug', 'automation']
            });
