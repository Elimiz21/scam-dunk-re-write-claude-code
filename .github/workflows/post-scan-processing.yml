name: Post-Scan Processing

# This workflow runs phases 2-5 (filtering, news analysis, social media scanning)
# on EXISTING risk-scored data from a previous scan.
# Use this when the full pipeline failed after Phase 1 or when you want to
# re-process existing data with updated logic.

on:
  workflow_dispatch:
    inputs:
      evaluation_date:
        description: 'Date of the risk data to process (YYYY-MM-DD)'
        required: true
        type: string
      data_source:
        description: 'Source of HIGH risk stocks'
        required: true
        default: 'supabase'
        type: choice
        options:
          - supabase
          - storage
      skip_news_analysis:
        description: 'Skip news legitimacy analysis (OpenAI)'
        required: false
        default: 'false'
        type: boolean
      skip_social_scan:
        description: 'Skip social media scanning'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

jobs:
  post-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate required secrets
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          MISSING=""
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then MISSING="$MISSING NEXT_PUBLIC_SUPABASE_URL"; fi
          if [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then MISSING="$MISSING NEXT_PUBLIC_SUPABASE_ANON_KEY"; fi
          if [ -z "$FMP_API_KEY" ]; then MISSING="$MISSING FMP_API_KEY"; fi

          if [ -n "$MISSING" ]; then
            echo "::error::Missing required secrets:$MISSING"
            exit 1
          fi

          if [ -z "$OPENAI_API_KEY" ]; then
            echo "::warning::OPENAI_API_KEY not set - news analysis will be pattern-based only"
          fi

          echo "All required secrets are configured"

      - name: Run Post-Scan Processing
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          EVALUATION_DATE: ${{ github.event.inputs.evaluation_date }}
          DATA_SOURCE: ${{ github.event.inputs.data_source }}
          SKIP_NEWS: ${{ github.event.inputs.skip_news_analysis }}
          SKIP_SOCIAL: ${{ github.event.inputs.skip_social_scan }}
        run: |
          cd evaluation
          echo "=========================================="
          echo "POST-SCAN PROCESSING"
          echo "=========================================="
          echo "Date: $EVALUATION_DATE"
          echo "Data source: $DATA_SOURCE"
          echo "Skip news analysis: $SKIP_NEWS"
          echo "Skip social scan: $SKIP_SOCIAL"
          echo ""

          # Run the post-scan phases script
          npx ts-node scripts/run-post-scan-phases.ts

          echo ""
          echo "Post-scan processing complete"

      - name: Upload to Supabase
        continue-on-error: true
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          EVALUATION_DATE: ${{ github.event.inputs.evaluation_date }}
        run: |
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
            echo "Supabase not configured, skipping upload"
            exit 0
          fi

          cd evaluation
          DATE="$EVALUATION_DATE"
          UPLOADED=0

          # Upload result files
          for file in results/*${DATE}*.json; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              echo "Uploading $FILENAME..."
              HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null -X POST \
                "${NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/evaluation-data/${FILENAME}" \
                -H "Authorization: Bearer ${NEXT_PUBLIC_SUPABASE_ANON_KEY}" \
                -H "Content-Type: application/json" \
                -H "x-upsert: true" \
                --data-binary @"$file")
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
                echo "  OK ($HTTP_CODE)"
                UPLOADED=$((UPLOADED + 1))
              else
                echo "  Warning: HTTP $HTTP_CODE"
              fi
            fi
          done

          echo "Uploaded $UPLOADED files to Supabase"

      - name: Checkout data repository
        uses: actions/checkout@v4
        with:
          repository: Elimiz21/scam-dunk-data
          token: ${{ secrets.DATA_REPO_TOKEN }}
          path: data-repo

      - name: Copy results to data repository
        env:
          EVALUATION_DATE: ${{ github.event.inputs.evaluation_date }}
        run: |
          DATE="$EVALUATION_DATE"

          mkdir -p data-repo/suspicious-stocks
          mkdir -p data-repo/reports
          mkdir -p data-repo/social-media-scans

          # Copy post-scan results
          cp evaluation/results/suspicious-stocks-${DATE}.json data-repo/suspicious-stocks/ 2>/dev/null || true
          cp evaluation/results/post-scan-report-${DATE}.json data-repo/reports/ 2>/dev/null || true
          cp evaluation/results/filtered-high-risk-${DATE}.json data-repo/suspicious-stocks/ 2>/dev/null || true

          echo "Files copied to data-repo:"
          find data-repo -name "*${DATE}*" -type f 2>/dev/null | sort

      - name: Commit results to data repository
        env:
          EVALUATION_DATE: ${{ github.event.inputs.evaluation_date }}
        run: |
          cd data-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add post-scan processing results for ${EVALUATION_DATE}"
            git push
            echo "Results pushed to scam-dunk-data repository"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-scan-results-${{ github.event.inputs.evaluation_date }}
          path: |
            evaluation/results/*.json
          retention-days: 30
          if-no-files-found: warn

      - name: Summary
        env:
          EVALUATION_DATE: ${{ github.event.inputs.evaluation_date }}
        run: |
          DATE="$EVALUATION_DATE"
          echo "## Post-Scan Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** ${DATE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "evaluation/results/post-scan-report-${DATE}.json" ]; then
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            cat evaluation/results/post-scan-report-${DATE}.json | jq -r '
              "- **Input HIGH Risk Stocks:** \(.totalHighRiskInput)",
              "- **Filtered by Market Cap:** \(.filteredByMarketCap)",
              "- **Filtered by Volume:** \(.filteredByVolume)",
              "- **Filtered by News:** \(.filteredByNews)",
              "- **Remaining Suspicious:** \(.remainingSuspicious)",
              "- **New Schemes:** \(.newSchemes)",
              "- **Processing Time:** \(.processingTimeMinutes) minutes"
            ' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Unable to parse report" >> $GITHUB_STEP_SUMMARY
          fi

  notify-on-failure:
    needs: post-scan
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send failure email alert
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          EVALUATION_DATE: ${{ github.event.inputs.evaluation_date }}
        run: |
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ -z "$RESEND_API_KEY" ]; then
            echo "RESEND_API_KEY not set, skipping email"
            exit 0
          fi

          curl -s -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer $RESEND_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"from\": \"ScamDunk Alerts <noreply@scamdunk.com>\",
              \"to\": [\"elimizroch@gmail.com\"],
              \"subject\": \"ðŸš¨ Post-Scan Processing FAILED - ${EVALUATION_DATE}\",
              \"html\": \"<h2>Post-Scan Processing Failed</h2><p>The post-scan processing for <strong>${EVALUATION_DATE}</strong> failed.</p><p><a href='${WORKFLOW_URL}'>View Workflow Logs</a></p>\"
            }" && echo "Failure alert sent"
